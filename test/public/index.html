<!DOCTYPE HTML>
<html>
<head>
<title>Testing conversion from math.js node to cMathML</title>
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

<script type="text/javascript" async src="https://code.jquery.com/jquery-1.8.3.js"></script>

<script>window.MathJax = { MathML: { extensions: ["mml3.js", "content-mathml.js"]}};</script>
<script type="text/javascript" src="lib/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<!--<script type="text/javascript" src="cases/examples.json"></script>-->
<style>
hr{
	height:2px;
	color: black;
	background-color: black;
}
b{
	color: teal;
}
.node{
	color: teal;
	font-weight: bold;
}
.json, textarea{
	width: 80%;
  padding: 10px;
	overflow: auto;
}
.json{
	border: 1px solid grey;
}
textarea{
height:200px;
}

#content p {
  background: #ccc;
  padding: 10px;
}

</style>

</head>
<body class="w3-container">

<div id="navigate">
	<h2>Navigate
	<button onclick="compact(-1)" class="w3-btn w3-purple w3-margin-bottom w3-medium"><i class="fa fa-compress"></i> Minify all</button>
	<button onclick="full(-1)" class="w3-btn w3-margin-left w3-indigo w3-margin-bottom w3-medium"><i class="fa fa-expand"></i> Expand all</button></h2>
</div>




<hr/>

<div id="content"></div>

<p class="w3-bottom w3-padding">
  <a href="#navigate" class="w3-right w3-button w3-circle w3-blue-grey"><i class="fa fa-arrow-up"></i></a>
	<button onclick="compact(-1)" class="w3-right w3-button w3-circle w3-purple w3-mediump"><i class="fa fa-compress"></i></button>
	<button onclick="full(-1)" class="w3-right w3-button w3-circle w3-margin-left w3-indigo w3-medium"><i class="fa fa-expand"></i></button><br/>
</p>

<script type="text/javascript">
"use strict";
var node,
    cont,
		cases = [];
var content = document.getElementById("content");

//Get cases
let xhr = new XMLHttpRequest();
xhr.open("GET","http://localhost:3000/cases/examples.json", false);
xhr.send();
if (xhr.responseText) {
	cases = JSON.parse(xhr.responseText);
}
else {
	console.log(xhr);
}



cases.forEach(function(x, i) {
	/*Generate <div> with information about formula*/
    var divData = document.createElement("div");
    divData.setAttribute("id", "data"+i);

        var header2 = document.createElement("h2");
        header2.innerHTML = `Example #${i}`;
		divData.appendChild(header2);

        var header3 = document.createElement("h3");
        header3.innerHTML = "input:";
		divData.appendChild(header3);

        var p = document.createElement("p");
        p.innerHTML = x;
        divData.appendChild(p);

        header3 = document.createElement("h3");
        header3.innerHTML = "parsing of input by math.js to Node object:";
		divData.appendChild(header3);

		var button = document.createElement("button");
        button.setAttribute("onclick", "compact("+i+")");
        button.innerHTML = "Minify";
        divData.appendChild(button);

        button = document.createElement("button");
        button.setAttribute("onclick", "full("+i+")");
        button.innerHTML = "Expand";
        divData.appendChild(button);

        var br = document.createElement("br");
        divData.appendChild(br);

        var innerDiv = document.createElement("div");
        innerDiv.setAttribute("id", "json"+i);
        innerDiv.setAttribute("class", "json");
        divData.appendChild(innerDiv);

        divData.appendChild(br);

        header3 = document.createElement("h3");
        header3.innerHTML = "cMathML produced by our code from Node object";
		divData.appendChild(header3);

		var textarea = document.createElement("textarea");
        textarea.setAttribute("id","textarea"+i);
        divData.appendChild(textarea);

		divData.appendChild(br);

        header3 = document.createElement("h3");
        header3.innerHTML = "MathJax presentation of TeX generated from input:";
		divData.appendChild(header3);

        innerDiv = document.createElement("div");
        innerDiv.setAttribute("id", "formula"+i);
        divData.appendChild(innerDiv);

        header3 = document.createElement("h3");
        header3.innerHTML = "MathJax presentation of cMathML generated by our code:";
		divData.appendChild(header3);

        innerDiv = document.createElement("div");
        innerDiv.setAttribute("id", "cformula"+i);
        innerDiv.setAttribute("style", "text-align:center");
        divData.appendChild(innerDiv);

        innerDiv = document.createElement("div");
        innerDiv.setAttribute("style", "padding:20px;");
            var link = document.createElement("a");
            link.setAttribute("href", "#navigate");
            link.innerHTML = "Up";
            innerDiv.appendChild(link);
        divData.appendChild(innerDiv);

        var hr = document.createElement("hr");
        divData.appendChild(hr);
    content.appendChild(divData);

    //var expTreeMathjs = math.parse(x);
		var cMathML = null, expTreeMathjs = null, latexFormula = null;

		var xhr = new XMLHttpRequest();
		console.log(x);
		xhr.open("GET","/mathsToCMathML?formula="+x.replace('+', '%2B'), false);
		xhr.send();
		if (xhr.status == 200) {
			let response = JSON.parse(xhr.responseText)
			cMathML = response.cMathML;
			expTreeMathjs = response.formula;
			latexFormula = response.tex;
		}
		else {
			console.log(xhr);
		}

    if (cMathML) {

        /*for output JSON mathjs expression tree*/
        var JSON_mathjs = stripJSON( JSON.stringify(expTreeMathjs, null, 2) );

        /*for output cMathML-code*/
        var sXML = cMathML;

        /* Fill <div>*/
        document.getElementById("formula"+i).innerHTML = "$$"+latexFormula+"$$";
        document.getElementById("json"+i).innerHTML += JSON_mathjs+"<br/>";
        document.getElementById("navigate").innerHTML += `<a href='#data${i}'>Example #${i}: ${x}</a><br/>`;
        document.getElementById("textarea"+i).innerHTML = sXML.replace(/></g,">\n<");
        document.getElementById("cformula"+i).innerHTML = cMathML;
    }
    else {
        document.getElementById("formula"+i).innerHTML = x+": Incorrect symbol"+(x.match(/[^\^*\/+-\w()_,. ]/) && x.match(/[^\^*\/+-\w()_,. ]/)[0]);
				document.getElementById("navigate").innerHTML += `<a style="color:red" href='#data${i}'>Example #${i}: ${x}</a><br/>`;
    }

});
/*Subscribe functions*/
function stripJSON(cont) {
	cont = cont.replace(/\n/g, "<br/>");
	cont = cont.replace(/ /g, "&nbsp;");
	return cont;
}

function compact(n) {
    if (n >= 0) {
        (document.getElementsByClassName("json")[n]).style.height = "300px";
    }
    else {
        $(".json").css("height", "300px");
    }
}

function full(n) {
	if (n >= 0) {
		(document.getElementsByClassName("json")[n]).style.height = "auto";
	}
	else {
		$(".json").css("height", "auto");
	}
}
</script>

</body>
</html>
