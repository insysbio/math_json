<!DOCTYPE HTML>
<html>
<head>
<title>Testing conversion from math.js node to cMathML</title>
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">

<script type="text/javascript" async src="https://code.jquery.com/jquery-1.8.3.js"></script>

<script>window.MathJax = { MathML: { extensions: ["mml3.js", "content-mathml.js"]}};</script>
<script type="text/javascript" src="lib/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<!--<script type="text/javascript" src="cases/examples.json"></script>-->
<style>
hr{
	height:2px;
	color: black;
	background-color: black;
}
b{
	color: teal;
}
.node{
	color: teal;
	font-weight: bold;
}
.json, textarea{
	width: 80%;
  padding: 10px;
	overflow: auto;
}
.json{
	border: 1px solid grey;
}
textarea{
height:200px;
}

p {
  background: #ccc;
  padding: 10px;
}

</style>

</head>
<body>

<div id="navigate">
	<h2>Navigate</h2>
</div>

<br/>

<button onclick="compact(-1)">Minify all</button><button onclick="full(-1)">Expand all</button>

<hr/>

<div id="content"></div>

<script type="text/javascript">
"use strict";
var node,
    cont,
		test_formula;
var content = document.getElementById("content");

/*let xhr = new XMLHttpRequest();
xhr.open("GET","http://localhost:3000/cases/examples.json", true);
if (xhr.status == 200) {
	test_formula = xhr.responseText;
}
else {
	console.log(xhr);
	test_formula = [];
}*/

test_formula = [
  "Default*(kabs*C0)",
  "(-vabs)/Default",
  "k3*gal+k1*lac/K_l+k2*alac/K_a+k44*x1+k44*x2",
  "V___1___+V___2___-V___3___-V___4___",
  "1+K2_H1_D/10^(-6.3)+10^(-6.3)/K2_H2_D",
	"alf_pH_D*(1+NAD/Kd_NAD_D+NADH/Kd_NADH_D)+bet_pH_D*(Hol/Kd_Hol_D+Hol*NAD/Kd_NAD_Hol_D/Kd_NAD_D)+gam_pH_D*(NADH*Hal/Kd_Hal_NADH_D/Kd_Hal_D+Hal/Kd_Hal_D+NAD*Hal/Kd_Hal_NAD_D/Kd_Hal_D+His*NADH/Kd_NADH_His_D/Kd_NADH_D+His/Kd_His_D)",
  "(1+L_dm*F_dm^(n-1)*H_dm^n)/(1+L_dm*(F_dm*H_dm)^n)",
  "V___5___*2.000-V___7___",  "SDH*((kf_SDH/(1+Sal/Ki_Sal_SDH))*Suc_SDH*Q_SDH-kr_SDH*Fum_SDH*QH2_SDH)/(1+Suc_SDH+Q_SDH*Km_i_Suc_SDH/Kd_es_Suc_SDH+Suc_SDH*Q_SDH+Fum_SDH+Km_Fum_SDH*QH2_SDH/Kd_ef_Fum_SDH+Fum_SDH*QH2_SDH)",
  "1/v_mix",
  "V_1*k2*(A1-A2)",
  "t/60",
  "k*(S-X1)/(1+X6^n/Ki^n)",
  "23*s_4*exp(d*12)",
  "rrr*pow(rrr, q)",
  "45*min2(eee*33, k_1)",
  "koff*min3(1,fun1,fun2)",
  "k0*sin(t)",
  "sqrt(e)",
  "abs(-ppp)",
  "-a+b+c",
  "a >= b+c",
  "koff <= min3(1,fun1,fun2)","1 > K2_H1_D/10^(-6.3)+10^(-6.3)/K2_H2_D",
  "V___5___ < 2.000-V___7___",
  "f(x, y, z) = x+y+z",
  "E==mc^2",
  "t==1 or t==2 or t ==3",
  "x < 0 ? x + a : 20",
  "f(a,b,c,d) = a > b ? c : d",
  "f(x,y) = x-y > 0 ? x : y",
  "f(x,y) = x / abs(x)",
  "f(x,y,z) = (x-y > 0 ? x : y)-z > 0 ? (x-y > 0 ? x : y) : z",
  "f(x, y, z) = x > 0 ? y + z :  y < 1 ? 12 : 8",
  "f(x, y, z) = y < 1 ? (x < 2 ? 1: 4): 12 ",
  "5",
  "x*5.1",
  "x*5.1e-3",
  "x*5e-3",
	"x < 2 ? 1: 4",
	"(x < 2 ? 1: 4)"
];


test_formula.forEach(function(x, i) {
	/*Generate <div> with information about formula*/
    var divData = document.createElement("div");
    divData.setAttribute("id", "data"+i);

        var header2 = document.createElement("h2");
        header2.innerHTML = `Example #${i}`;
		divData.appendChild(header2);

        var header3 = document.createElement("h3");
        header3.innerHTML = "input:";
		divData.appendChild(header3);

        var p = document.createElement("p");
        p.innerHTML = x;
        divData.appendChild(p);

        header3 = document.createElement("h3");
        header3.innerHTML = "parsing of input by math.js to Node object:";
		divData.appendChild(header3);

		var button = document.createElement("button");
        button.setAttribute("onclick", "compact("+i+")");
        button.innerHTML = "Minify";
        divData.appendChild(button);

        button = document.createElement("button");
        button.setAttribute("onclick", "full("+i+")");
        button.innerHTML = "Expand";
        divData.appendChild(button);

        var br = document.createElement("br");
        divData.appendChild(br);

        var innerDiv = document.createElement("div");
        innerDiv.setAttribute("id", "json"+i);
        innerDiv.setAttribute("class", "json");
        divData.appendChild(innerDiv);

        divData.appendChild(br);

        header3 = document.createElement("h3");
        header3.innerHTML = "cMathML produced by our code from Node object";
		divData.appendChild(header3);

		var textarea = document.createElement("textarea");
        textarea.setAttribute("id","textarea"+i);
        divData.appendChild(textarea);

		divData.appendChild(br);

        header3 = document.createElement("h3");
        header3.innerHTML = "MathJax presentation of TeX generated from input:";
		divData.appendChild(header3);

        innerDiv = document.createElement("div");
        innerDiv.setAttribute("id", "formula"+i);
        divData.appendChild(innerDiv);

        header3 = document.createElement("h3");
        header3.innerHTML = "MathJax presentation of cMathML generated by our code:";
		divData.appendChild(header3);

        innerDiv = document.createElement("div");
        innerDiv.setAttribute("id", "cformula"+i);
        innerDiv.setAttribute("style", "text-align:center");
        divData.appendChild(innerDiv);

        innerDiv = document.createElement("div");
        innerDiv.setAttribute("style", "padding:20px;");
            var link = document.createElement("a");
            link.setAttribute("href", "#navigate");
            link.innerHTML = "Up";
            innerDiv.appendChild(link);
        divData.appendChild(innerDiv);

        var hr = document.createElement("hr");
        divData.appendChild(hr);
    content.appendChild(divData);

    //var expTreeMathjs = math.parse(x);
		var cMathML = null, expTreeMathjs = null, latexFormula = null;

		var xhr = new XMLHttpRequest();
		console.log(x);
		xhr.open("GET","/mathsToCMathML?formula="+x.replace('+', '%2B'), false);
		xhr.send();
		if (xhr.status == 200) {
			let response = JSON.parse(xhr.responseText)
			cMathML = response.cMathML;
			expTreeMathjs = response.formula;
			latexFormula = response.tex;
		}
		else {
			console.log(xhr);
		}
		console.log(x);
		console.log(expTreeMathjs);
    if (cMathML) {

        //var formula = expTreeMathjs.toTex().replace(/_/g,"\\_");

        /*for output JSON mathjs expression tree*/
        var JSON_mathjs = stripJSON( JSON.stringify(expTreeMathjs, null, 2) );

        /*for output cMathML-code*/
        var sXML = cMathML;

        /* Fill <div>*/
        document.getElementById("formula"+i).innerHTML = "$$"+latexFormula+"$$";
        document.getElementById("json"+i).innerHTML += JSON_mathjs+"<br/>";
        document.getElementById("navigate").innerHTML += `<a href='#data${i}'>Example #${i}: ${x}</a><br/>`;
        document.getElementById("textarea"+i).innerHTML = sXML.replace(/></g,">\n<");
        document.getElementById("cformula"+i).innerHTML = cMathML;
    }
    else {
        //document.getElementById("formula"+i).innerHTML = mathObject.toString()+": Incorrect symbol"+mathObject.toString().match(/[^\^*\/+-\w()_,. ]/)[0];
    }


});
/*Subscribe functions*/
function stripJSON(cont) {
	cont = cont.replace(/\n/g, "<br/>");
	cont = cont.replace(/ /g, "&nbsp;");
	return cont;
}

function compact(n) {
    if (n >= 0) {
        (document.getElementsByClassName("json")[n]).style.height = "300px";
    }
    else {
        $(".json").css("height", "300px");
    }
}

function full(n) {
	if (n >= 0) {
		(document.getElementsByClassName("json")[n]).style.height = "auto";
	}
	else {
		$(".json").css("height", "auto");
	}
}
</script>

</body>
</html>
